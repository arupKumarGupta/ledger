var w=Object.defineProperty;var z=(p,t,r)=>t in p?w(p,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):p[t]=r;var S=(p,t,r)=>(z(p,typeof t!="symbol"?t+"":t,r),r);import{f as k}from"./index-C9yNgNbR.js";class T{constructor({marshaller:t,serializer:r,deserializer:n,serdeContext:o,defaultContentType:l}){S(this,"marshaller");S(this,"serializer");S(this,"deserializer");S(this,"serdeContext");S(this,"defaultContentType");this.marshaller=t,this.serializer=r,this.deserializer=n,this.serdeContext=o,this.defaultContentType=l}async serializeEventStream({eventStream:t,requestSchema:r,initialRequest:n}){const o=this.marshaller,l=r.getEventStreamMember(),u=r.getMemberSchema(l),c=this.serializer,y=this.defaultContentType,d=Symbol("initialRequestMarker"),h={async*[Symbol.asyncIterator](){if(n){const s={":event-type":{type:"string",value:"initial-request"},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:y}};c.write(r,n);const m=c.flush();yield{[d]:!0,headers:s,body:m}}for await(const s of t)yield s}};return o.serialize(h,s=>{if(s[d])return{headers:s.headers,body:s.body};const m=Object.keys(s).find(f=>f!=="__type")??"",{additionalHeaders:a,body:e,eventType:i,explicitPayloadContentType:g}=this.writeEventBody(m,u,s);return{headers:{":event-type":{type:"string",value:i},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:g??y},...a},body:e}})}async deserializeEventStream({response:t,responseSchema:r,initialResponseContainer:n}){var m;const o=this.marshaller,l=r.getEventStreamMember(),c=r.getMemberSchema(l).getMemberSchemas(),y=Symbol("initialResponseMarker"),d=o.deserialize(t.body,async a=>{const e=Object.keys(a).find(i=>i!=="__type")??"";if(e==="initial-response"){const i=await this.deserializer.read(r,a[e].body);return delete i[l],{[y]:!0,...i}}else if(e in c){const i=c[e];return{[e]:await this.deserializer.read(i,a[e].body)}}else return{$unknown:a}}),h=d[Symbol.asyncIterator](),s=await h.next();if(s.done)return d;if((m=s.value)!=null&&m[y]){if(!r)throw new Error("@smithy::core/protocols - initial-response event encountered in event stream but no response schema given.");for(const[a,e]of Object.entries(s.value))n[a]=e}return{async*[Symbol.asyncIterator](){var a;for((a=s==null?void 0:s.value)!=null&&a[y]||(yield s.value);;){const{done:e,value:i}=await h.next();if(e)break;yield i}}}}writeEventBody(t,r,n){var m;const o=this.serializer;let l=t,u=null,c;const y=r.getSchema()[4].includes(t),d={};if(y){const a=r.getMemberSchema(t);if(a.isStructSchema()){for(const[e,i]of a.structIterator()){const{eventHeader:g,eventPayload:v}=i.getMergedTraits();if(v){u=e;break}else if(g){const f=n[t][e];let b="binary";i.isNumericSchema()?(-2)**31<=f&&f<=2**31-1?b="integer":b="long":i.isTimestampSchema()?b="timestamp":i.isStringSchema()?b="string":i.isBooleanSchema()&&(b="boolean"),f!=null&&(d[e]={type:b,value:f},delete n[t][e])}}if(u!==null){const e=a.getMemberSchema(u);e.isBlobSchema()?c="application/octet-stream":e.isStringSchema()&&(c="text/plain"),o.write(e,n[t][u])}else o.write(a,n[t])}else throw new Error("@smithy/core/event-streams - non-struct member not supported in event stream union.")}else{const[a,e]=n[t];l=a,o.write(15,e)}const h=o.flush();return{body:typeof h=="string"?(((m=this.serdeContext)==null?void 0:m.utf8Decoder)??k)(h):h,eventType:l,explicitPayloadContentType:c,additionalHeaders:d}}}export{T as EventStreamSerde};
